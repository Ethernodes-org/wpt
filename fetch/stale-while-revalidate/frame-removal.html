<!DOCTYPE html>
<meta charset="utf-8">
<title>Test that frame removal cancels its revalidations</title>
<script src="/resources/testharness.js"></script>
<script src="/resources/testharnessreport.js"></script>
<script src="/common/utils.js"></script>
<body>
<script>

const wait_for_message = () => {
  return new Promise((resolve, reject) => {
    window.addEventListener('message', e => {
      resolve(e);
    });
  });
};

async_test(async function(t) {
  let frame = document.createElement("iframe");
  frame.src = "resources/frame-removal.html";
  frame.onload = t.step_func(async () => {
    frame.contentWindow.postMessage('start', '*');
    let message = await wait_for_message();
    let request_token = message.data;

    frame.remove();
    const revalidation_check = await fetch(`resources/stale-script.py?query&token=` + request_token);
    if (revalidation_check.headers.get('Count') == '1') {
      t.done();
    }
  });
  document.body.appendChild(frame);
}, 'Frame removal should cancel its revalidations');
</script>
</body>
